name: CI
on:
  pull_request:
  merge_group:
  schedule:
    - cron: '* * * * *'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Test
        run: cat README.md

  open_pr:
    name: Open PR
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: [success]
    steps:
      - uses: actions/checkout@master
      - run: |
          git config user.name "Deploy from CI"
          git config user.email ""
          git checkout -B cron-br
          echo $RANDOM >> README.md
          git add README.md
          git commit -m "Test random"
          git push -u origin cron-br
          gh workflow run open_pr.yml -f branch=cron-br

  success:
    name: Success gate
    if: always()
    needs:
      - test
    runs-on: ubuntu-latest
    steps:
      - run: jq --exit-status 'all(.result == "success")' <<< '${{ toJson(needs) }}'
      - name: Done
        run: exit 0
